<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2395px" preserveAspectRatio="none" style="width:1585px;height:2395px;" version="1.1" viewBox="0 0 1585 2395" width="1585px" zoomAndPan="magnify"><defs><filter height="300%" id="fppujnrv771yx" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="385" x="601" y="23.5352">5.2.2. Record Funds Out Abort (recordFundsOutAbort)</text><rect fill="#FFB6C1" height="2350.4102" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="34.5" y="47.0566">Central HUB</text><rect fill="#FFFFE0" height="2350.4102" style="stroke: #A80036; stroke-width: 1.0;" width="1024" x="296" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="757.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="349" y="293.4609"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="578" y="698.9141"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="2141.123" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="776" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="1369.0117" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="922" y="904.3984"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="982.3301"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1192.5039"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1345.6777"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1514.1621"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1752.5781"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1937.0625"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="2044.3047"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="2127.123" style="stroke: #000000; stroke-width: 2.0;" width="1561" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="1325.7012" style="stroke: #000000; stroke-width: 2.0;" width="706.5" x="857.5" y="919.3984"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="171.1738" style="stroke: #000000; stroke-width: 2.0;" width="625.5" x="867.5" y="943.709"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="1084.2168" style="stroke: #000000; stroke-width: 2.0;" width="686.5" x="867.5" y="1153.8828"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="75" x2="75" y1="137.2871" y2="2298.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="354" x2="354" y1="137.2871" y2="2298.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="582.5" x2="582.5" y1="137.2871" y2="2298.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="781" x2="781" y1="137.2871" y2="2298.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="926.5" x2="926.5" y1="137.2871" y2="2298.4102"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1268" x2="1268" y1="137.2871" y2="2298.4102"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="134.334">Hub Employee</text><ellipse cx="75" cy="63.7988" fill="#FEFECE" filter="url(#fppujnrv771yx)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,71.7988 L75,98.7988 M62,79.7988 L88,79.7988 M75,98.7988 L62,113.7988 M75,98.7988 L88,113.7988 " fill="none" filter="url(#fppujnrv771yx)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="23" y="2310.9453">Hub Employee</text><ellipse cx="75" cy="2323.8984" fill="#FEFECE" filter="url(#fppujnrv771yx)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M75,2331.8984 L75,2358.8984 M62,2339.8984 L88,2339.8984 M75,2358.8984 L62,2373.8984 M75,2358.8984 L88,2373.8984 " fill="none" filter="url(#fppujnrv771yx)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="300" y="117.8457">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="317.5" y="134.334">Admin API</text><path d="M333.5,76.3105 L333.5,100.3105 M333.5,88.3105 L350.5,88.3105 " fill="none" filter="url(#fppujnrv771yx)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="362.5" cy="88.3105" fill="#FEFECE" filter="url(#fppujnrv771yx)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="300" y="2310.9453">Central Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="317.5" y="2327.4336">Admin API</text><path d="M333.5,2334.3867 L333.5,2358.3867 M333.5,2346.3867 L350.5,2346.3867 " fill="none" filter="url(#fppujnrv771yx)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="362.5" cy="2346.3867" fill="#FEFECE" filter="url(#fppujnrv771yx)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#fppujnrv771yx)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="497.5" y="97.7988"/><rect fill="#FEFECE" filter="url(#fppujnrv771yx)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="493.5" y="101.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="500.5" y="122.334">Admin-Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fppujnrv771yx)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="497.5" y="2297.4102"/><rect fill="#FEFECE" filter="url(#fppujnrv771yx)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="171" x="493.5" y="2301.4102"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="500.5" y="2321.9453">Admin-Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="706" y="134.334">Admin Event Handler</text><ellipse cx="781" cy="104.7988" fill="#FEFECE" filter="url(#fppujnrv771yx)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="777,92.7988,783,87.7988,781,92.7988,783,97.7988,777,92.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="706" y="2310.9453">Admin Event Handler</text><ellipse cx="781" cy="2329.8984" fill="#FEFECE" filter="url(#fppujnrv771yx)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="777,2317.8984,783,2312.8984,781,2317.8984,783,2322.8984,777,2317.8984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="877.5" y="134.334">Transfer DAO</text><ellipse cx="927" cy="104.7988" fill="#FEFECE" filter="url(#fppujnrv771yx)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="915" x2="939" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="877.5" y="2310.9453">Transfer DAO</text><ellipse cx="927" cy="2329.8984" fill="#FEFECE" filter="url(#fppujnrv771yx)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="915" x2="939" y1="2343.8984" y2="2343.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1220" y="134.334">Central Store</text><path d="M1250,84.7988 C1250,74.7988 1268,74.7988 1268,74.7988 C1268,74.7988 1286,74.7988 1286,84.7988 L1286,110.7988 C1286,120.7988 1268,120.7988 1268,120.7988 C1268,120.7988 1250,120.7988 1250,110.7988 L1250,84.7988 " fill="#FEFECE" filter="url(#fppujnrv771yx)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1250,84.7988 C1250,94.7988 1268,94.7988 1268,94.7988 C1268,94.7988 1286,94.7988 1286,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1220" y="2310.9453">Central Store</text><path d="M1250,2323.8984 C1250,2313.8984 1268,2313.8984 1268,2313.8984 C1268,2313.8984 1286,2313.8984 1286,2323.8984 L1286,2349.8984 C1286,2359.8984 1268,2359.8984 1268,2359.8984 C1268,2359.8984 1250,2359.8984 1250,2349.8984 L1250,2323.8984 " fill="#FEFECE" filter="url(#fppujnrv771yx)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1250,2323.8984 C1250,2333.8984 1268,2333.8984 1268,2333.8984 C1268,2333.8984 1286,2333.8984 1286,2323.8984 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="552.3164" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="349" y="293.4609"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="117.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="578" y="698.9141"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="2141.123" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="776" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="1369.0117" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="922" y="904.3984"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="982.3301"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1192.5039"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1345.6777"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1514.1621"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1752.5781"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="1937.0625"/><rect fill="#FFFFFF" filter="url(#fppujnrv771yx)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1263" y="2044.3047"/><path d="M13,154.2871 L221,154.2871 L221,161.2871 L211,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2127.123" style="stroke: #000000; stroke-width: 2.0;" width="1561" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="28" y="167.8555">Record Funds Out Abort</text><path d="M80,176.5977 L80,247.5977 L324,247.5977 L324,186.5977 L314,176.5977 L80,176.5977 " fill="#FFFF00" filter="url(#fppujnrv771yx)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M314,176.5977 L314,186.5977 L324,186.5977 L314,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="102" y="209.4766">"action": "recordFundsOutAbort",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="102" y="224.7871">"reason": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="86" y="240.0977">}</text><polygon fill="#A80036" points="337,289.4609,347,293.4609,337,297.4609,341,293.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="75" x2="343" y1="293.4609" y2="293.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="82" y="281.0635">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="95" y="273.4082">PUT - /participants/{name}/accounts/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="139" y="288.7188">{id}/transfers/{transferId}</text><path d="M364,306.4609 L364,652.4609 L630,652.4609 L630,316.4609 L620,306.4609 L364,306.4609 " fill="#FFFF00" filter="url(#fppujnrv771yx)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M620,306.4609 L620,316.4609 L630,316.4609 L620,306.4609 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="370" y="324.0293">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="370" y="339.3398">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="154" x="386" y="354.6504">id: &lt;payload.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="386" y="369.9609">from: "hub",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="386" y="385.2715">to: "dfspName",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="386" y="400.582">type: "application/json"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="386" y="415.8926">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="402" y="431.2031">headers: &lt;payloadHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="402" y="446.5137">payload: &lt;payloadMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="386" y="461.8242">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="386" y="477.1348">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="402" y="492.4453">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="418" y="507.7559">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="418" y="523.0664">responseTo: "",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="418" y="538.377">type: "transfer",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="418" y="553.6875">action: "recordFundsOutAbort",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="418" y="568.998">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="418" y="584.3086">state: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="402" y="599.6191">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="386" y="614.9297">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="34" x="386" y="630.2402">pp: ""</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="370" y="645.5508">}</text><polygon fill="#A80036" points="566,694.9141,576,698.9141,566,702.9141,570,698.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="359" x2="572" y1="698.9141" y2="698.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="366" y="686.5166">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="379" y="678.8613">Route &amp; Publish Prepare event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="379" y="694.1719">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="456" y="694.1719">2003</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="588" x2="630" y1="758.8457" y2="758.8457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="630" x2="630" y1="758.8457" y2="771.8457"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="589" x2="630" y1="771.8457" y2="771.8457"/><polygon fill="#A80036" points="599,767.8457,589,771.8457,599,775.8457,595,771.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="595" y="738.793">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="608" y="723.4824">Ensure event is replicated</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="608" y="738.793">as configured (ACKS=all)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="608" y="754.1035">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="685" y="754.1035">2003</text><polygon fill="#A80036" points="370,812.4668,360,816.4668,370,820.4668,366,816.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="364" x2="582" y1="816.4668" y2="816.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="376" y="804.0693">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="389" y="796.4141">Respond replication acks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="389" y="811.7246">have been received</text><polygon fill="#A80036" points="86,841.7773,76,845.7773,86,849.7773,82,845.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="80" x2="353" y1="845.7773" y2="845.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="92" y="841.0352">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="105" y="841.0352">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="594,871.0879,584,875.0879,594,879.0879,590,875.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="588" x2="775" y1="875.0879" y2="875.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="600" y="870.3457">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="613" y="870.3457">Consume message</text><polygon fill="#A80036" points="910,900.3984,920,904.3984,910,908.3984,914,904.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="786" x2="916" y1="904.3984" y2="904.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="793" y="899.6563">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="806" y="899.6563">Abort transfer</text><path d="M857.5,919.3984 L1022.5,919.3984 L1022.5,926.3984 L1012.5,936.3984 L857.5,936.3984 L857.5,919.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1325.7012" style="stroke: #000000; stroke-width: 2.0;" width="706.5" x="857.5" y="919.3984"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="872.5" y="932.9668">DB TRANSACTION</text><path d="M867.5,943.709 L1124.5,943.709 L1124.5,950.709 L1114.5,960.709 L867.5,960.709 L867.5,943.709 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="171.1738" style="stroke: #000000; stroke-width: 2.0;" width="625.5" x="867.5" y="943.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="212" x="882.5" y="957.2773">Reconciliation Transfer Commit</text><polygon fill="#A80036" points="1251,978.3301,1261,982.3301,1251,986.3301,1255,982.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1257" y1="982.3301" y2="982.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="939" y="977.5879">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="952" y="977.5879">Insert transferFulfilment record</text><polygon fill="#FFFFE0" filter="url(#fppujnrv771yx)" points="1062,1025.3301,1473,1025.3301,1483,1067.3301,1473,1109.3301,1062,1109.3301,1052,1067.3301,1062,1025.3301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1064" y="1041.8984">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="1148" y="1041.8984">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="1080" y="1057.209">(transferFulfilmentId, transferId, ilpFulfilment,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="1080" y="1072.5195">completedDate, isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1064" y="1087.8301">VALUES ({Uuid()}, {payload.transferId}, 0, {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="1080" y="1103.1406">1, NULL, {transactionTimestamp})</text><path d="M867.5,1153.8828 L1119.5,1153.8828 L1119.5,1160.8828 L1109.5,1170.8828 L867.5,1170.8828 L867.5,1153.8828 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1084.2168" style="stroke: #000000; stroke-width: 2.0;" width="686.5" x="867.5" y="1153.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="882.5" y="1167.4512">Reconciliation Position Change</text><polygon fill="#A80036" points="1251,1188.5039,1261,1192.5039,1251,1196.5039,1255,1192.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1257" y1="1192.5039" y2="1192.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="939" y="1187.7617">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="222" x="952" y="1187.7617">Retrieve hub reconciliation account</text><polygon fill="#FFFFE0" filter="url(#fppujnrv771yx)" points="1086,1205.5039,1449,1205.5039,1459,1247.5039,1449,1289.5039,1086,1289.5039,1076,1247.5039,1086,1205.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1088" y="1222.0723">SELECT participantCurrencyId AS reconciliationAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1088" y="1237.3828">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1128" y="1237.3828">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="1088" y="1252.6934">WHERE participantId = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="1088" y="1268.0039">AND currencyId = {payload.amount.currency}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1088" y="1283.3145">LIMIT 1</text><polygon fill="#A80036" points="943,1312.3672,933,1316.3672,943,1320.3672,939,1316.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="937" x2="1267" y1="1316.3672" y2="1316.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="949" y="1311.625">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="971" y="1311.625">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="1016" y="1311.625">reconciliationAccountId</text><polygon fill="#A80036" points="1251,1341.6777,1261,1345.6777,1251,1349.6777,1255,1345.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1257" y1="1345.6777" y2="1345.6777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="939" y="1340.9355">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="961" y="1340.9355">Select hub reconciliation account position</text><polygon fill="#FFFFE0" filter="url(#fppujnrv771yx)" points="1086,1358.6777,1449,1358.6777,1459,1400.6777,1449,1442.6777,1086,1442.6777,1076,1400.6777,1086,1358.6777" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="1088" y="1375.2461">SELECT participantPositionId AS reconciliationPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="1104" y="1390.5566">value AS reconciliationPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1088" y="1405.8672">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1128" y="1405.8672">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1088" y="1421.1777">WHERE participantCurrencyId = {reconciliationAccountId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1088" y="1436.4883">LIMIT 1</text><polygon fill="#A80036" points="943,1480.8516,933,1484.8516,943,1488.8516,939,1484.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="937" x2="1267" y1="1484.8516" y2="1484.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="949" y="1472.4541">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="971" y="1464.7988">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1016" y="1464.7988">reconciliationPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1173" y="1464.7988">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="182" x="971" y="1480.1094">reconciliationPositionValue</text><polygon fill="#A80036" points="1251,1510.1621,1261,1514.1621,1251,1518.1621,1255,1514.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1257" y1="1514.1621" y2="1514.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="939" y="1509.4199">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="961" y="1509.4199">Select participant settlement account position</text><polygon fill="#FFFFE0" filter="url(#fppujnrv771yx)" points="1067,1527.1621,1469,1527.1621,1479,1569.1621,1469,1611.1621,1067,1611.1621,1057,1569.1621,1067,1527.1621" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1069" y="1543.7305">SELECT participantPositionId AS settlementPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1085" y="1559.041">value AS settlementPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1069" y="1574.3516">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1109" y="1574.3516">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="398" x="1069" y="1589.6621">WHERE participantCurrencyId = {payload.participantCurrencyId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="1069" y="1604.9727">LIMIT 1</text><polygon fill="#A80036" points="943,1649.3359,933,1653.3359,943,1657.3359,939,1653.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="937" x2="1267" y1="1653.3359" y2="1653.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="949" y="1640.9385">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="971" y="1633.2832">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="1016" y="1633.2832">settlementPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1154" y="1633.2832">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="163" x="971" y="1648.5938">settlementPositionValue</text><path d="M937,1666.3359 L937,1721.3359 L1417,1721.3359 L1417,1676.3359 L1407,1666.3359 L937,1666.3359 " fill="#D3D3D3" filter="url(#fppujnrv771yx)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1407,1666.3359 L1407,1676.3359 L1417,1676.3359 L1407,1666.3359 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="943" y="1683.9043">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="52" x="963" y="1683.9043">amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1019" y="1683.9043">=</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="1033" y="1683.9043">payload.amount.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="943" y="1699.2148">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="963" y="1699.2148">latestReconciliationPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1151" y="1699.2148">= reconciliationPositionValue + amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="943" y="1714.5254">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="162" x="963" y="1714.5254">latestSettlementPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="1129" y="1714.5254">= settlementPositionValue - amount</text><polygon fill="#A80036" points="1251,1748.5781,1261,1752.5781,1251,1756.5781,1255,1752.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1257" y1="1752.5781" y2="1752.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="939" y="1747.8359">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="961" y="1747.8359">Persist participant position</text><polygon fill="#FFFFE0" filter="url(#fppujnrv771yx)" points="1089,1795.5781,1446,1795.5781,1456,1852.5781,1446,1910.5781,1089,1910.5781,1079,1852.5781,1089,1795.5781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1091" y="1812.1465">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1145" y="1812.1465">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="1091" y="1827.457">SET value = {latestReconciliationPosition}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="1091" y="1842.7676">WHERE participantPositionId = {reconciliationPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1095" y="1858.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1091" y="1873.3887">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1145" y="1873.3887">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="1091" y="1888.6992">SET value = {latestSettlementPosition}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="1091" y="1904.0098">WHERE participantPositionId = {settlementPositionId}</text><polygon fill="#A80036" points="1251,1933.0625,1261,1937.0625,1251,1941.0625,1255,1937.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1257" y1="1937.0625" y2="1937.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="939" y="1932.3203">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="961" y="1932.3203">Change transfer state</text><polygon fill="#FFFFE0" filter="url(#fppujnrv771yx)" points="1001,1950.0625,1534,1950.0625,1544,1969.0625,1534,1988.0625,1001,1988.0625,991,1969.0625,1001,1950.0625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1003" y="1966.6309">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1087" y="1966.6309">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1230" y="1966.6309">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="1003" y="1981.9414">VALUES ({payload.transferId, 'ABORTED', {payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="943,2010.9941,933,2014.9941,943,2018.9941,939,2014.9941" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="937" x2="1267" y1="2014.9941" y2="2014.9941"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="949" y="2010.252">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="971" y="2010.252">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="1016" y="2010.252">transferStateChangeId</text><polygon fill="#A80036" points="1251,2040.3047,1261,2044.3047,1251,2048.3047,1255,2044.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1257" y1="2044.3047" y2="2044.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="939" y="2039.5625">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="961" y="2039.5625">Persist participant position change</text><polygon fill="#FFFFE0" filter="url(#fppujnrv771yx)" points="1063,2087.3047,1473,2087.3047,1483,2159.3047,1473,2232.3047,1063,2232.3047,1053,2159.3047,1063,2087.3047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1065" y="2103.873">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1149" y="2103.873">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1332" y="2103.873">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="1081" y="2119.1836">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="1065" y="2134.4941">VALUES ({reconciliationPositionId}, 'ABORTED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="1081" y="2149.8047">{latestReconciliationPosition}, 0, {transactionTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1069" y="2165.1152"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1065" y="2180.4258">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1149" y="2180.4258">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1332" y="2180.4258">(participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="1081" y="2195.7363">transferStateChangeId, value, reservedValue, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="1065" y="2211.0469">VALUES ({settlementPositionId}, 'ABORTED',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1081" y="2226.3574">{latestSettlementPosition}, 0, {transactionTimestamp})</text><polygon fill="#A80036" points="797,2269.4102,787,2273.4102,797,2277.4102,793,2273.4102" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="791" x2="926" y1="2273.4102" y2="2273.4102"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="803" y="2268.668">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="825" y="2268.668">Finished await</text><!--
@startuml
title 5.2.2. Record Funds Out Abort (recordFundsOutAbort)

autonumber


actor "Hub Employee" as OPERATOR
boundary "Central Service\n Admin API" as CS_ADMIN_API
collections "Admin-Transfer-Topic" as TOPIC_ADMIN_TRANSFER
control "Admin Event Handler" as ADMIN_HANDLER
entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Central Service" #LightYellow
    participant CS_ADMIN_API
	participant TOPIC_ADMIN_TRANSFER
    participant ADMIN_HANDLER
    participant TRANSFER_DAO
    participant DB
end box

activate ADMIN_HANDLER
group Record Funds Out Abort
    note right of OPERATOR #yellow
        {
            "action": "recordFundsOutAbort",
            "reason": "string"
        }
    end note
    OPERATOR -> CS_ADMIN_API: PUT - /participants/{name}/accounts/\n           {id}/transfers/{transferId}
    activate CS_ADMIN_API

    note right of CS_ADMIN_API #yellow
        Message:
        {
            id: <payload.transferId>
            from: "hub",
            to: "dfspName",
            type: "application/json"
            content: {
                headers: <payloadHeaders>,
                payload: <payloadMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: "",
                    type: "transfer",
                    action: "recordFundsOutAbort",
                    createdAt: <timestamp>,
                    state: ""
                }
            },
            pp: ""
        }
    end note
    CS_ADMIN_API -> TOPIC_ADMIN_TRANSFER: Route & Publish Prepare event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_ADMIN_TRANSFER
    TOPIC_ADMIN_TRANSFER <-> TOPIC_ADMIN_TRANSFER: Ensure event is replicated\nas configured (ACKS=all)\n<color #FF0000><b>Error code:</b> 2003</color>
    TOPIC_ADMIN_TRANSFER - -> CS_ADMIN_API: Respond replication acks\nhave been received
    deactivate TOPIC_ADMIN_TRANSFER
    CS_ADMIN_API - - -> OPERATOR: Respond HTTP - 202 (Accepted)
    deactivate CS_ADMIN_API

    TOPIC_ADMIN_TRANSFER <- ADMIN_HANDLER: Consume message
    ADMIN_HANDLER -> TRANSFER_DAO: Abort transfer
    activate TRANSFER_DAO
    group <color #blue>DB TRANSACTION</color>
        group Reconciliation Transfer Commit
            TRANSFER_DAO -> DB: Insert transferFulfilment record
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilment**
                    (transferFulfilmentId, transferId, ilpFulfilment,
                    completedDate, isValid, settlementWindowId, createdDate)
                VALUES ({Uuid()}, {payload.transferId}, 0, {transactionTimestamp},
                    1, NULL, {transactionTimestamp})
            end hnote
        end
        |||
        group Reconciliation Position Change
            TRANSFER_DAO -> DB: Retrieve hub reconciliation account
            activate DB
            hnote over DB #lightyellow
                SELECT participantCurrencyId AS reconciliationAccountId
                FROM **participantCurrency**
                WHERE participantId = 1
                AND currencyId = {payload.amount.currency}
                LIMIT 1
            end hnote
            TRANSFER_DAO <- - DB: Return **reconciliationAccountId**
            deactivate DB

            TRANSFER_DAO -> DB: Select hub reconciliation account position
            activate DB
            hnote over DB #lightyellow
                SELECT participantPositionId AS reconciliationPositionId,
                    value AS reconciliationPositionValue
                FROM **participantPosition**
                WHERE participantCurrencyId = {reconciliationAccountId}
                LIMIT 1
            end hnote
            TRANSFER_DAO <- - DB: Return **reconciliationPositionId**,\n**reconciliationPositionValue**
            deactivate DB

            TRANSFER_DAO -> DB: Select participant settlement account position
            activate DB
            hnote over DB #lightyellow
                SELECT participantPositionId AS settlementPositionId,
                    value AS settlementPositionValue
                FROM **participantPosition**
                WHERE participantCurrencyId = {payload.participantCurrencyId}
                LIMIT 1
            end hnote
            TRANSFER_DAO <- - DB: Return **settlementPositionId**,\n**settlementPositionValue**
            deactivate DB

            note right of TRANSFER_DAO #lightgray
                let **amount** = <color #blue>payload.amount.amount</color>
                let **latestReconciliationPosition** = reconciliationPositionValue + amount
                let **latestSettlementPosition** = settlementPositionValue - amount
            end note

            TRANSFER_DAO -> DB: Persist participant position
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = {latestReconciliationPosition}
                WHERE participantPositionId = {reconciliationPositionId}

                UPDATE **participantPosition**
                SET value = {latestSettlementPosition}
                WHERE participantPositionId = {settlementPositionId}
            end hnote

            TRANSFER_DAO -> DB: Change transfer state
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason, createdDate)
                VALUES ({payload.transferId, 'ABORTED', {payload.reason}, {transactionTimestamp})
            end hnote
            TRANSFER_DAO <- - DB: Return **transferStateChangeId**
            deactivate DB

            TRANSFER_DAO -> DB: Persist participant position change
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                INSERT INTO **participantPositionChange** (participantPositionId,
                    transferStateChangeId, value, reservedValue, createdDate)
                VALUES ({reconciliationPositionId}, 'ABORTED',
                    {latestReconciliationPosition}, 0, {transactionTimestamp})

                INSERT INTO **participantPositionChange** (participantPositionId,
                    transferStateChangeId, value, reservedValue, createdDate)
                VALUES ({settlementPositionId}, 'ABORTED',
                    {latestSettlementPosition}, 0, {transactionTimestamp})
            end hnote
        end
    end
    ADMIN_HANDLER <- - TRANSFER_DAO: Finished await
    deactivate TRANSFER_DAO
end
deactivate ADMIN_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 22:00:17 CEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>