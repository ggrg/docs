<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4753px" preserveAspectRatio="none" style="width:1907px;height:4753px;" version="1.1" viewBox="0 0 1907 4753" width="1907px" zoomAndPan="magnify"><defs><filter height="300%" id="f8aotz6ipvg0s" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="771.5" y="23.5352">1.1.1.a. Prepare Handler Consume (single message)</text><rect fill="#FFFFE0" height="4708.0215" style="stroke: #A80036; stroke-width: 1.0;" width="1790.5" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="863.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="108" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="4540.7344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="909" y="4042.1289"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1199" y="4615.0215"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="726.1875"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="1154.5352"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="1369.0195"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="91.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="2306.5039"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="3072.8887"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="3362.2598"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1445.5" y="2466.0566"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1445.5" y="2720.8516"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="755.498"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="1183.8457"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="1398.3301"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="2495.3672"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="2750.1621"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="3102.1992"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="3391.5703"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="4526.7344" style="stroke: #000000; stroke-width: 2.0;" width="1883" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="262" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="272" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="858" x="272" y="337.1504"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="3074.041" style="stroke: #000000; stroke-width: 2.0;" width="1664" x="222" y="508.7031"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="1725.8691" style="stroke: #000000; stroke-width: 2.0;" width="1644" x="232" y="687.5664"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="1544.0059" style="stroke: #000000; stroke-width: 2.0;" width="1624" x="242" y="862.4297"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="858" x="272" y="886.7402"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="1147.3242" style="stroke: #000000; stroke-width: 2.0;" width="1604" x="252" y="1100.6035"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="828.6426" style="stroke: #000000; stroke-width: 2.0;" width="1584" x="262" y="1306.0879"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="797.332" style="stroke: #000000; stroke-width: 2.0;" width="1564" x="272" y="1330.3984"/><rect fill="#FFFFFF" height="57.2656" style="stroke: none; stroke-width: 1.0;" width="1564" x="272" y="1995.5781"/><rect fill="#FFFFFF" height="74.8867" style="stroke: none; stroke-width: 1.0;" width="1564" x="272" y="2052.8438"/><rect fill="#FFFFFF" height="106.1973" style="stroke: none; stroke-width: 1.0;" width="1604" x="252" y="2141.7305"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="77.2422" style="stroke: #000000; stroke-width: 2.0;" width="1015.5" x="272" y="2163.6855"/><rect fill="#FFFFFF" height="151.5078" style="stroke: none; stroke-width: 1.0;" width="1624" x="242" y="2254.9277"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1569" x="272" y="2427.4355"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1569" x="272" y="2682.2305"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1591" x="262" y="2994.6465"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1571" x="272" y="3018.957"/><rect fill="#FFFFFF" height="304.6816" style="stroke: none; stroke-width: 1.0;" width="1591" x="262" y="3271.0625"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1571" x="272" y="3293.0176"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="1015.5" x="272" y="3596.7441"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="1015.5" x="272" y="4080.1289"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="113" x2="113" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="361" x2="361" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="914" x2="914" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1067" x2="1067" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1203.5" x2="1203.5" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1335.5" x2="1335.5" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1450.5" x2="1450.5" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1757.5" x2="1757.5" y1="116.2871" y2="4677.0215"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="30" y="101.334">topic-transfer-prepare</text><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="27" y="4676.0215"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="23" y="4680.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="30" y="4700.5566">topic-transfer-prepare</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="282" y="113.334">Prepare Event Handler</text><ellipse cx="361" cy="83.7988" fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="357,71.7988,363,66.7988,361,71.7988,363,76.7988,357,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="282" y="4689.5566">Prepare Event Handler</text><ellipse cx="361" cy="4708.5098" fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="357,4696.5098,363,4691.5098,361,4696.5098,363,4701.5098,357,4696.5098" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="827" y="76.7988"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="823" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="830" y="101.334">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="827" y="4676.0215"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="823" y="4680.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="830" y="4700.5566">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1019" y="76.7988"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1015" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1022" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1019" y="4676.0215"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1015" y="4680.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1022" y="4700.5566">Event-Topic</text><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1134.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1130.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1137.5" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1134.5" y="4676.0215"/><rect fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1130.5" y="4680.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1137.5" y="4700.5566">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1287.5" y="113.334">Position DAO</text><ellipse cx="1335.5" cy="83.7988" fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1323.5" x2="1347.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1287.5" y="4689.5566">Position DAO</text><ellipse cx="1335.5" cy="4708.5098" fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1323.5" x2="1347.5" y1="4722.5098" y2="4722.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1393.5" y="113.334">Participant DAO</text><ellipse cx="1450.5" cy="83.7988" fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1438.5" x2="1462.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1393.5" y="4689.5566">Participant DAO</text><ellipse cx="1450.5" cy="4708.5098" fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1438.5" x2="1462.5" y1="4722.5098" y2="4722.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1709.5" y="113.334">Central Store</text><path d="M1739.5,63.7988 C1739.5,53.7988 1757.5,53.7988 1757.5,53.7988 C1757.5,53.7988 1775.5,53.7988 1775.5,63.7988 L1775.5,89.7988 C1775.5,99.7988 1757.5,99.7988 1757.5,99.7988 C1757.5,99.7988 1739.5,99.7988 1739.5,89.7988 L1739.5,63.7988 " fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1739.5,63.7988 C1739.5,73.7988 1757.5,73.7988 1757.5,73.7988 C1757.5,73.7988 1775.5,73.7988 1775.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1709.5" y="4689.5566">Central Store</text><path d="M1739.5,4702.5098 C1739.5,4692.5098 1757.5,4692.5098 1757.5,4692.5098 C1757.5,4692.5098 1775.5,4692.5098 1775.5,4702.5098 L1775.5,4728.5098 C1775.5,4738.5098 1757.5,4738.5098 1757.5,4738.5098 C1757.5,4738.5098 1739.5,4738.5098 1739.5,4728.5098 L1739.5,4702.5098 " fill="#FEFECE" filter="url(#f8aotz6ipvg0s)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1739.5,4702.5098 C1739.5,4712.5098 1757.5,4712.5098 1757.5,4712.5098 C1757.5,4712.5098 1775.5,4712.5098 1775.5,4702.5098 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="108" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="4540.7344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="909" y="4042.1289"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1199" y="4615.0215"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="726.1875"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="1154.5352"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="1369.0195"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="91.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="2306.5039"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="3072.8887"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1330.5" y="3362.2598"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1445.5" y="2466.0566"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1445.5" y="2720.8516"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="755.498"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="1183.8457"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="1398.3301"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="2495.3672"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="2750.1621"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="3102.1992"/><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1752.5" y="3391.5703"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4526.7344" style="stroke: #000000; stroke-width: 2.0;" width="1883" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Prepare Handler Consume</text><polygon fill="#A80036" points="129,167.9082,119,171.9082,129,175.9082,125,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="123" x2="355" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="135" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="148" y="167.166">Consume Prepare event message</text><path d="M262,216.9082 L346,216.9082 L346,223.9082 L336,233.9082 L262,233.9082 L262,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="262" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="277" y="230.4766">break</text><path d="M272,241.2188 L414,241.2188 L414,248.2188 L404,258.2188 L272,258.2188 L272,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="272" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="287" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="295.1504" y2="295.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="295.1504" y2="308.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="308.1504" y2="308.1504"/><polygon fill="#A80036" points="377,304.1504,367,308.1504,377,312.1504,373,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="282.7529">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="386" y="275.0977">Validate event - Rule: type == 'prepare' &amp;&amp; action == 'prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="386" y="290.4082">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="470" y="290.4082">2001</text><path d="M272,337.1504 L487,337.1504 L487,344.1504 L477,354.1504 L272,354.1504 L272,337.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="858" x="272" y="337.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="287" y="350.7188">Persist Event Information</text><polygon fill="#A80036" points="1055.5,396.7715,1065.5,400.7715,1055.5,404.7715,1059.5,400.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1061.5" y1="400.7715" y2="400.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="396.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="386" y="396.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="840" x="279" y="408.7715"/><polygon fill="#EEEEEE" points="279,408.7715,343,408.7715,343,415.7715,333,425.7715,279,425.7715,279,408.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="423.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="602" y="442.3398">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="760" y="442.3398">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="760" x2="792" y1="444.3398" y2="444.3398"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="792" y="442.3398">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="606" y="457.6504"/><path d="M222,508.7031 L441,508.7031 L441,515.7031 L431,525.7031 L222,525.7031 L222,508.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3074.041" style="stroke: #000000; stroke-width: 2.0;" width="1664" x="222" y="508.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="237" y="522.2715">Validate Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="547.3242" y2="547.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="547.3242" y2="560.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="560.3242" y2="560.3242"/><polygon fill="#A80036" points="377,556.3242,367,560.3242,377,564.3242,373,560.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="542.582">4</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="386" y="542.582">Schema validation of the incoming message</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="589.6348" y2="589.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="589.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="602.6348" y2="602.6348"/><polygon fill="#A80036" points="377,598.6348,367,602.6348,377,606.6348,373,602.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="584.8926">5</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="386" y="584.8926">Verify the message's signature (to be confirmed in future requirement)</text><path d="M371,615.6348 L371,670.6348 L736,670.6348 L736,625.6348 L726,615.6348 L371,615.6348 " fill="#D3D3D3" filter="url(#f8aotz6ipvg0s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M726,615.6348 L726,625.6348 L736,625.6348 L726,615.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="377" y="633.2031">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="377" y="648.5137">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="377" y="663.8242">It may need to be added in future for custom adapters.</text><path d="M232,687.5664 L443,687.5664 L443,694.5664 L433,704.5664 L232,704.5664 L232,687.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1725.8691" style="stroke: #000000; stroke-width: 2.0;" width="1644" x="232" y="687.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="166" x="247" y="701.1348">Validate Duplicate check</text><polygon fill="#A80036" points="1318.5,722.1875,1328.5,726.1875,1318.5,730.1875,1322.5,726.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1324.5" y1="726.1875" y2="726.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="373" y="721.4453">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="386" y="721.4453">Request to retrieve Transfer Hash for a transferId</text><polygon fill="#A80036" points="1740.5,751.498,1750.5,755.498,1740.5,759.498,1744.5,755.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1340.5" x2="1746.5" y1="755.498" y2="755.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1347.5" y="750.7559">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="1360.5" y="750.7559">Request Transfer Hash for a transferId</text><polygon fill="#FFFFE0" filter="url(#f8aotz6ipvg0s)" points="1681,768.498,1833,768.498,1843,779.498,1833,791.498,1681,791.498,1671,779.498,1681,768.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1683" y="785.0664">transferDuplicateCheck</text><polygon fill="#A80036" points="1351.5,814.1191,1341.5,818.1191,1351.5,822.1191,1347.5,818.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1345.5" x2="1756.5" y1="818.1191" y2="818.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1357.5" y="813.377">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1370.5" y="813.377">Return hash if it exists</text><polygon fill="#A80036" points="377,843.4297,367,847.4297,377,851.4297,373,847.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1334.5" y1="847.4297" y2="847.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="383" y="842.6875">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="396" y="842.6875">Return hash if it exists</text><path d="M242,862.4297 L304,862.4297 L304,869.4297 L294,879.4297 L242,879.4297 L242,862.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1544.0059" style="stroke: #000000; stroke-width: 2.0;" width="1624" x="242" y="862.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="257" y="875.998">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="319" y="875.0645">[If transferId exists]</text><path d="M272,886.7402 L487,886.7402 L487,893.7402 L477,903.7402 L272,903.7402 L272,886.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="858" x="272" y="886.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="287" y="900.3086">Persist Event Information</text><polygon fill="#A80036" points="1055.5,946.3613,1065.5,950.3613,1055.5,954.3613,1059.5,950.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1061.5" y1="950.3613" y2="950.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="945.6191">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="395" y="945.6191">Publish event information</text><rect fill="#FFFFFF" filter="url(#f8aotz6ipvg0s)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="840" x="279" y="958.3613"/><polygon fill="#EEEEEE" points="279,958.3613,343,958.3613,343,965.3613,333,975.3613,279,975.3613,279,958.3613" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="292" y="972.9297">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="602" y="991.9297">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="760" y="991.9297">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="760" x2="792" y1="993.9297" y2="993.9297"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="792" y="991.9297">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="606" y="1007.2402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="1072.6035" y2="1072.6035"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="1072.6035" y2="1085.6035"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="1085.6035" y2="1085.6035"/><polygon fill="#A80036" points="377,1081.6035,367,1085.6035,377,1089.6035,373,1085.6035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1067.8613">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="395" y="1067.8613">Generate Hash for the incoming message and compare hashes</text><path d="M252,1100.6035 L314,1100.6035 L314,1107.6035 L304,1117.6035 L252,1117.6035 L252,1100.6035 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1147.3242" style="stroke: #000000; stroke-width: 2.0;" width="1604" x="252" y="1100.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="267" y="1114.1719">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="175" x="329" y="1113.2383">[Transfer exists, hash matches]</text><polygon fill="#A80036" points="1318.5,1150.5352,1328.5,1154.5352,1318.5,1158.5352,1322.5,1154.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1324.5" y1="1154.5352" y2="1154.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1142.1377">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="395" y="1134.4824">Request to retrieve Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="395" y="1149.793">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="472" y="1149.793">2003</text><polygon fill="#A80036" points="1740.5,1179.8457,1750.5,1183.8457,1740.5,1187.8457,1744.5,1183.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1340.5" x2="1746.5" y1="1183.8457" y2="1183.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1347.5" y="1179.1035">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1369.5" y="1179.1035">Request Transfer state</text><polygon fill="#FFFFE0" filter="url(#f8aotz6ipvg0s)" points="1692,1196.8457,1823,1196.8457,1833,1215.8457,1823,1234.8457,1692,1234.8457,1682,1215.8457,1692,1196.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1694" y="1213.4141">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1694" y="1228.7246">transferStateChange</text><polygon fill="#A80036" points="1351.5,1257.7773,1341.5,1261.7773,1351.5,1265.7773,1347.5,1261.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1345.5" x2="1756.5" y1="1261.7773" y2="1261.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1357.5" y="1257.0352">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="1379.5" y="1257.0352">Return Transfer state</text><polygon fill="#A80036" points="377,1287.0879,367,1291.0879,377,1295.0879,373,1291.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1334.5" y1="1291.0879" y2="1291.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1286.3457">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="405" y="1286.3457">Return Transfer state</text><path d="M262,1306.0879 L346,1306.0879 L346,1313.0879 L336,1323.0879 L262,1323.0879 L262,1306.0879 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="828.6426" style="stroke: #000000; stroke-width: 2.0;" width="1584" x="262" y="1306.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="277" y="1319.6563">break</text><path d="M272,1330.3984 L334,1330.3984 L334,1337.3984 L324,1347.3984 L272,1347.3984 L272,1330.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="797.332" style="stroke: #000000; stroke-width: 2.0;" width="1564" x="272" y="1330.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="287" y="1343.9668">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="267" x="349" y="1343.0332">[If transferState IN ['COMMITTED', 'ABORTED']]</text><polygon fill="#A80036" points="1318.5,1365.0195,1328.5,1369.0195,1318.5,1373.0195,1322.5,1369.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1324.5" y1="1369.0195" y2="1369.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1364.2773">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="395" y="1364.2773">Request to retrieve fulfilment, completedTimestamp for the transferId</text><polygon fill="#A80036" points="1740.5,1394.3301,1750.5,1398.3301,1740.5,1402.3301,1744.5,1398.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1340.5" x2="1746.5" y1="1398.3301" y2="1398.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1347.5" y="1393.5879">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="1369.5" y="1393.5879">Request fulfilment, completedTimestamp for the transferId</text><polygon fill="#FFFFE0" filter="url(#f8aotz6ipvg0s)" points="1699,1411.3301,1816,1411.3301,1826,1422.3301,1816,1434.3301,1699,1434.3301,1689,1422.3301,1699,1411.3301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1701" y="1427.8984">transferFulfilment</text><polygon fill="#A80036" points="1351.5,1456.9512,1341.5,1460.9512,1351.5,1464.9512,1347.5,1460.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1345.5" x2="1756.5" y1="1460.9512" y2="1460.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1357.5" y="1456.209">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1379.5" y="1456.209">Return fulfilment, completedTimestamp (if they exist)</text><polygon fill="#A80036" points="377,1486.2617,367,1490.2617,377,1494.2617,373,1490.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1334.5" y1="1490.2617" y2="1490.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="1485.5195">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="405" y="1485.5195">Return fulfilment, completedTimestamp (if they exist)</text><path d="M371,1503.2617 L371,1941.2617 L857,1941.2617 L857,1513.2617 L847,1503.2617 L371,1503.2617 " fill="#FFFF00" filter="url(#f8aotz6ipvg0s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M847,1503.2617 L847,1513.2617 L857,1513.2617 L847,1503.2617 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="377" y="1520.8301">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="1536.1406">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="1551.4512">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="393" y="1566.7617">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="393" y="1582.0723">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="393" y="1597.3828">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="393" y="1612.6934">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="409" y="1628.0039">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="409" y="1643.3145">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="425" y="1658.625">transferState: "COMMITTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="417" x="425" y="1673.9355">fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="425" y="1689.2461">completedTimestamp: "2018-10-24T08:38:08.699-04:00"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="1704.5566">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="393" y="1719.8672">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="393" y="1735.1777">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="409" y="1750.4883">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="425" y="1765.7988">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="425" y="1781.1094">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="425" y="1796.4199">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="425" y="1811.7305">action: prepare-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="425" y="1827.041">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="425" y="1842.3516">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="441" y="1857.6621">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="441" y="1872.9727">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="1888.2832">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="1903.5938">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1918.9043">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="1934.2148">}</text><polygon fill="#A80036" points="1192,1983.5781,1202,1987.5781,1192,1991.5781,1196,1987.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1198" y1="1987.5781" y2="1987.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="1975.1807">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="395" y="1967.5254">Publish Notification event for Payer with the completed transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="792" x="395" y="1982.8359">For the Data Model, refer to the Swagger (transferState - mandatory, fulfilment, completedTimestamp - sample values above).</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="272" x2="1836" y1="1996.5781" y2="1996.5781"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="256" x="277" y="2007.2129">[If transferState IN ['RECEIVED', 'RESERVED']]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="2031.8438" y2="2031.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="2031.8438" y2="2044.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="2044.8438" y2="2044.8438"/><polygon fill="#A80036" points="377,2040.8438,367,2044.8438,377,2048.8438,373,2044.8438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2027.1016">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="507" x="395" y="2027.1016">This request can be ignored, because a callback is about to be sent to the client.</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="272" x2="1836" y1="2053.8438" y2="2053.8438"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="173" x="277" y="2064.4785">[If transferState does not exist]</text><polygon fill="#A80036" points="1192,2115.7305,1202,2119.7305,1192,2123.7305,1196,2119.7305" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1198" y1="2119.7305" y2="2119.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2099.6777">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="395" y="2084.3672">Send /error callback with appropriate error message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="395" y="2099.6777">(Invalid duplicate request)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="395" y="2114.9883">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="472" y="2114.9883">3100</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="252" x2="1856" y1="2142.7305" y2="2142.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="257" y="2153.3652">[Transfer exists, hash does not match]</text><path d="M272,2163.6855 L356,2163.6855 L356,2170.6855 L346,2180.6855 L272,2180.6855 L272,2163.6855 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="77.2422" style="stroke: #000000; stroke-width: 2.0;" width="1015.5" x="272" y="2163.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="287" y="2177.2539">break</text><polygon fill="#A80036" points="1192,2228.9277,1202,2232.9277,1192,2236.9277,1196,2232.9277" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1198" y1="2232.9277" y2="2232.9277"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2212.875">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="395" y="2197.5645">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2212.875">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2212.875">3106</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="515" y="2212.875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="487" x="395" y="2228.1855">For the Data Model, refer to the final step in this diagram (has the same text).</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="242" x2="1866" y1="2255.9277" y2="2255.9277"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="247" y="2266.5625">[If transferId does NOT exist]</text><polygon fill="#A80036" points="1318.5,2302.5039,1328.5,2306.5039,1318.5,2310.5039,1322.5,2306.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1324.5" y1="2306.5039" y2="2306.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2294.1064">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="395" y="2286.4512">Request to persist Transfer Hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="395" y="2301.7617">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="472" y="2301.7617">2003</text><polygon fill="#A80036" points="1745.5,2331.8145,1755.5,2335.8145,1745.5,2339.8145,1749.5,2335.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1340.5" x2="1751.5" y1="2335.8145" y2="2335.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1347.5" y="2331.0723">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="1369.5" y="2331.0723">Persist Transfer message hash</text><polygon fill="#FFFFE0" filter="url(#f8aotz6ipvg0s)" points="1681,2348.8145,1833,2348.8145,1843,2359.8145,1833,2371.8145,1681,2371.8145,1671,2359.8145,1681,2348.8145" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1683" y="2365.3828">transferDuplicateCheck</text><polygon fill="#A80036" points="377,2394.4355,367,2398.4355,377,2402.4355,373,2398.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1334.5" y1="2398.4355" y2="2398.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="2393.6934">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="405" y="2393.6934">Return success</text><path d="M272,2427.4355 L414,2427.4355 L414,2434.4355 L404,2444.4355 L272,2444.4355 L272,2427.4355 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1569" x="272" y="2427.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="287" y="2441.0039">Validate Payer</text><polygon fill="#A80036" points="1433.5,2462.0566,1443.5,2466.0566,1433.5,2470.0566,1437.5,2466.0566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1439.5" y1="2466.0566" y2="2466.0566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2461.3145">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="395" y="2461.3145">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1740.5,2491.3672,1750.5,2495.3672,1740.5,2499.3672,1744.5,2495.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1746.5" y1="2495.3672" y2="2495.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1462.5" y="2490.625">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1484.5" y="2490.625">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f8aotz6ipvg0s)" points="1693,2508.3672,1821,2508.3672,1831,2527.3672,1821,2546.3672,1693,2546.3672,1683,2527.3672,1693,2508.3672" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1695" y="2524.9355">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1695" y="2540.2461">participantCurrency</text><polygon fill="#A80036" points="1466.5,2569.2988,1456.5,2573.2988,1466.5,2577.2988,1462.5,2573.2988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1460.5" x2="1756.5" y1="2573.2988" y2="2573.2988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1472.5" y="2568.5566">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1494.5" y="2568.5566">Return Participant details if it exists</text><polygon fill="#A80036" points="377,2598.6094,367,2602.6094,377,2606.6094,373,2602.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1449.5" y1="2602.6094" y2="2602.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="2597.8672">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="405" y="2597.8672">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="2647.2305" y2="2647.2305"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="2647.2305" y2="2660.2305"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="2660.2305" y2="2660.2305"/><polygon fill="#A80036" points="377,2656.2305,367,2660.2305,377,2664.2305,373,2660.2305" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2634.833">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="395" y="2627.1777">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2642.4883">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2642.4883">3202</text><path d="M272,2682.2305 L416,2682.2305 L416,2689.2305 L406,2699.2305 L272,2699.2305 L272,2682.2305 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1569" x="272" y="2682.2305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="287" y="2695.7988">Validate Payee</text><polygon fill="#A80036" points="1433.5,2716.8516,1443.5,2720.8516,1433.5,2724.8516,1437.5,2720.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1439.5" y1="2720.8516" y2="2720.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2716.1094">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="395" y="2716.1094">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1740.5,2746.1621,1750.5,2750.1621,1740.5,2754.1621,1744.5,2750.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1455.5" x2="1746.5" y1="2750.1621" y2="2750.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1462.5" y="2745.4199">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1484.5" y="2745.4199">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f8aotz6ipvg0s)" points="1693,2763.1621,1821,2763.1621,1831,2782.1621,1821,2801.1621,1693,2801.1621,1683,2782.1621,1693,2763.1621" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1695" y="2779.7305">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1695" y="2795.041">participantCurrency</text><polygon fill="#A80036" points="1466.5,2824.0938,1456.5,2828.0938,1466.5,2832.0938,1462.5,2828.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1460.5" x2="1756.5" y1="2828.0938" y2="2828.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1472.5" y="2823.3516">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1494.5" y="2823.3516">Return Participant details if it exists</text><polygon fill="#A80036" points="377,2853.4043,367,2857.4043,377,2861.4043,373,2857.4043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1449.5" y1="2857.4043" y2="2857.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="2852.6621">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="405" y="2852.6621">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="2902.0254" y2="2902.0254"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="2902.0254" y2="2915.0254"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="2915.0254" y2="2915.0254"/><polygon fill="#A80036" points="377,2911.0254,367,2915.0254,377,2919.0254,373,2915.0254" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2889.6279">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="395" y="2881.9727">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2897.2832">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2897.2832">3203</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="2966.6465" y2="2966.6465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="2966.6465" y2="2979.6465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="2979.6465" y2="2979.6465"/><polygon fill="#A80036" points="377,2975.6465,367,2979.6465,377,2983.6465,373,2979.6465" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="2954.249">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="395" y="2946.5938">Validate crypto-condition</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="2961.9043">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="2961.9043">3100</text><path d="M262,2994.6465 L324,2994.6465 L324,3001.6465 L314,3011.6465 L262,3011.6465 L262,2994.6465 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1591" x="262" y="2994.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="277" y="3008.2148">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="339" y="3007.2813">[Validate Prepare Transfer (success)]</text><path d="M272,3018.957 L744,3018.957 L744,3025.957 L734,3035.957 L272,3035.957 L272,3018.957 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1571" x="272" y="3018.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="427" x="287" y="3032.5254">Persist Transfer State (with transferState='RECEIVED-PREPARE')</text><polygon fill="#A80036" points="1318.5,3068.8887,1328.5,3072.8887,1318.5,3076.8887,1322.5,3072.8887" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1324.5" y1="3072.8887" y2="3072.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="3060.4912">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="395" y="3052.8359">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="3068.1465">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="3068.1465">2003</text><polygon fill="#A80036" points="1740.5,3098.1992,1750.5,3102.1992,1740.5,3106.1992,1744.5,3102.1992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1340.5" x2="1746.5" y1="3102.1992" y2="3102.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1347.5" y="3097.457">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1369.5" y="3097.457">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f8aotz6ipvg0s)" points="1692,3145.1992,1823,3145.1992,1833,3187.1992,1823,3229.1992,1692,3229.1992,1682,3187.1992,1692,3145.1992" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1694" y="3161.7676">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1694" y="3177.0781">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1694" y="3192.3887">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1694" y="3207.6992">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1694" y="3223.0098">ilpPacket</text><polygon fill="#A80036" points="377,3252.0625,367,3256.0625,377,3260.0625,373,3256.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1334.5" y1="3256.0625" y2="3256.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="3251.3203">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="405" y="3251.3203">Return success</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="262" x2="1853" y1="3272.0625" y2="3272.0625"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="267" y="3282.6973">[Validate Prepare Transfer (failure)]</text><path d="M272,3293.0176 L1055,3293.0176 L1055,3300.0176 L1045,3310.0176 L272,3310.0176 L272,3293.0176 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1571" x="272" y="3293.0176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="738" x="287" y="3306.5859">Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)</text><polygon fill="#A80036" points="1318.5,3358.2598,1328.5,3362.2598,1318.5,3366.2598,1322.5,3362.2598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1324.5" y1="3362.2598" y2="3362.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="3342.207">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="395" y="3326.8965">Request to persist transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="395" y="3342.207">(when Payee/Payer/crypto-condition validation fails)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="3357.5176">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="3357.5176">2003</text><polygon fill="#A80036" points="1740.5,3387.5703,1750.5,3391.5703,1740.5,3395.5703,1744.5,3391.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1340.5" x2="1746.5" y1="3391.5703" y2="3391.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1347.5" y="3386.8281">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1369.5" y="3386.8281">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f8aotz6ipvg0s)" points="1692,3434.5703,1823,3434.5703,1833,3483.5703,1823,3533.5703,1692,3533.5703,1682,3483.5703,1692,3434.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1694" y="3451.1387">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1694" y="3466.4492">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1694" y="3481.7598">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1694" y="3497.0703">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1694" y="3512.3809">transferError</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1694" y="3527.6914">ilpPacket</text><polygon fill="#A80036" points="377,3556.7441,367,3560.7441,377,3564.7441,373,3560.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="371" x2="1334.5" y1="3560.7441" y2="3560.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="383" y="3556.002">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="405" y="3556.002">Return success</text><path d="M272,3596.7441 L334,3596.7441 L334,3603.7441 L324,3613.7441 L272,3613.7441 L272,3596.7441 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="1015.5" x="272" y="3596.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="287" y="3610.3125">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="349" y="3609.3789">[Validate Prepare Transfer (success)]</text><path d="M371,3619.0547 L371,3996.0547 L633,3996.0547 L633,3629.0547 L623,3619.0547 L371,3619.0547 " fill="#FFFF00" filter="url(#f8aotz6ipvg0s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M623,3619.0547 L623,3629.0547 L633,3629.0547 L623,3619.0547 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="377" y="3636.623">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="3651.9336">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="3667.2441">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="393" y="3682.5547">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="393" y="3697.8652">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="393" y="3713.1758">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="393" y="3728.4863">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="409" y="3743.7969">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="409" y="3759.1074">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="393" y="3774.418">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="393" y="3789.7285">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="409" y="3805.0391">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="425" y="3820.3496">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="425" y="3835.6602">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="425" y="3850.9707">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="425" y="3866.2813">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="425" y="3881.5918">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="425" y="3896.9023">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="441" y="3912.2129">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="441" y="3927.5234">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="3942.834">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="3958.1445">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="3973.4551">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="3988.7656">}</text><polygon fill="#A80036" points="897,4038.1289,907,4042.1289,897,4046.1289,901,4042.1289" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="903" y1="4042.1289" y2="4042.1289"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="4029.7314">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="395" y="4022.0762">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="4037.3867">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="4037.3867">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="272" x2="1287.5" y1="4081.1289" y2="4081.1289"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="277" y="4091.7637">[Validate Prepare Transfer (failure)]</text><path d="M371,4100.084 L371,4569.084 L978,4569.084 L978,4110.084 L968,4100.084 L371,4100.084 " fill="#FFFF00" filter="url(#f8aotz6ipvg0s)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M968,4100.084 L968,4110.084 L978,4110.084 L968,4100.084 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="377" y="4117.6523">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="4132.9629">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="4148.2734">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="393" y="4163.584">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="393" y="4178.8945">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="393" y="4194.2051">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="393" y="4209.5156">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="409" y="4224.8262">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="409" y="4240.1367">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="425" y="4255.4473">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522" x="441" y="4270.7578">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="441" y="4286.0684">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="441" y="4301.3789">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="4316.6895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="393" y="4332">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="393" y="4347.3105">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="409" y="4362.6211">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="425" y="4377.9316">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="425" y="4393.2422">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="425" y="4408.5527">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="425" y="4423.8633">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="425" y="4439.1738">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="425" y="4454.4844">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="441" y="4469.7949">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="441" y="4485.1055">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="441" y="4500.416">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="425" y="4515.7266">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="4531.0371">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="4546.3477">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="4561.6582">}</text><polygon fill="#A80036" points="1187,4611.0215,1197,4615.0215,1187,4619.0215,1191,4615.0215" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="1193" y1="4615.0215" y2="4615.0215"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="373" y="4602.624">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="395" y="4594.9688">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="395" y="4610.2793">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="479" y="4610.2793">2003</text><!--
@startuml
title 1.1.1.a. Prepare Handler Consume (single message)

autonumber


collections "topic-transfer-prepare" as TOPIC_TRANSFER_PREPARE
control "Prepare Event Handler" as PREP_HANDLER
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Position DAO" as POS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_PREPARE
    participant PREP_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_TRANSFER_PREPARE <- PREP_HANDLER: Consume Prepare event message
    activate TOPIC_TRANSFER_PREPARE
    deactivate TOPIC_TRANSFER_PREPARE

    break
        group Validate Event
            PREP_HANDLER <-> PREP_HANDLER: Validate event - Rule: type == 'prepare' && action == 'prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]} \n
        |||
    end

    group Validate Prepare Transfer 
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Schema validation of the incoming message</color>
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Verify the message's signature (to be confirmed in future requirement)</color>
        note right of PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note
        group Validate Duplicate check
            PREP_HANDLER -> POS_DAO: Request to retrieve Transfer Hash for a transferId
            activate POS_DAO
            POS_DAO -> DB: Request Transfer Hash for a transferId
            activate DB
            hnote over DB #lightyellow
                transferDuplicateCheck
            end note
            POS_DAO <- - DB: Return hash if it exists
            deactivate DB
            PREP_HANDLER <- - POS_DAO: Return hash if it exists
            deactivate POS_DAO

            alt If transferId exists
                group Persist Event Information
                    |||
                    PREP_HANDLER -> TOPIC_EVENTS: Publish event information
                    ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/Diagrams/SequenceDiagrams/seq-event-9.1.0.svg 9.1.0]]} \n
                    |||
                end
                PREP_HANDLER -> PREP_HANDLER: Generate Hash for the incoming message and compare hashes

                alt Transfer exists, hash matches    
                    PREP_HANDLER -> POS_DAO: Request to retrieve Transfer state \n<color #FF0000><b>Error code:</b> 2003</color>
                    activate POS_DAO
                    POS_DAO -> DB: Request Transfer state
                    hnote over DB #lightyellow
                        transfer
                        transferStateChange
                    end note
                    activate DB
                    POS_DAO <- - DB: Return Transfer state
                    deactivate DB
                    POS_DAO - -> PREP_HANDLER: Return Transfer state
                    deactivate POS_DAO
                    break
                        alt If transferState IN ['COMMITTED', 'ABORTED']
                            PREP_HANDLER -> POS_DAO: Request to retrieve fulfilment, completedTimestamp for the transferId
                            activate POS_DAO
                            POS_DAO -> DB: Request fulfilment, completedTimestamp for the transferId
                            activate DB
                            hnote over DB #lightyellow
                                transferFulfilment
                            end note
                            POS_DAO <- - DB: Return fulfilment, completedTimestamp (if they exist)
                            deactivate DB
                            PREP_HANDLER <- - POS_DAO: Return fulfilment, completedTimestamp (if they exist)
                            deactivate POS_DAO
                            note right of PREP_HANDLER #yellow
                            Message:
                            {
                                id: <transferMessage.transferId>
                                from: <transferMessage.payerFsp>,
                                to: <transferMessage.payeeFsp>,
                                type: application/json
                                content: {
                                    headers: <transferHeaders>,
                                    payload: {
                                        transferState: "COMMITTED",
                                        fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",
                                        completedTimestamp: "2018-10-24T08:38:08.699-04:00"
                                    }
                                },
                                metadata: {
                                    event: {
                                        id: <uuid>,
                                        responseTo: <previous.uuid>,
                                        type: notification,
                                        action: prepare-duplicate,
                                        createdAt: <timestamp>,
                                        state: {
                                            status: "success",
                                            code: 0
                                        }
                                    }
                                }
                            }
                        end note
                            PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event for Payer with the completed transfer \nFor the Data Model, refer to the Swagger (transferState - mandatory, fulfilment, completedTimestamp - sample values above).
                        else If transferState IN ['RECEIVED', 'RESERVED']
                            PREP_HANDLER <-> PREP_HANDLER: This request can be ignored, because a callback is about to be sent to the client.
                        else If transferState does not exist
                            PREP_HANDLER -> TOPIC_NOTIFICATIONS: Send /error callback with appropriate error message\n(Invalid duplicate request)\n<color #FF0000><b>Error code:</b> 3100</color>
                        end
                    end
                else Transfer exists, hash does not match
                    break
                        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 3106</color> \nFor the Data Model, refer to the final step in this diagram (has the same text).
                    end
                end

            else If transferId does NOT exist
                PREP_HANDLER -> POS_DAO: Request to persist Transfer Hash \n<color #FF0000><b>Error code:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist Transfer message hash
                hnote over DB #lightyellow
                    transferDuplicateCheck
                end note
                POS_DAO - -> PREP_HANDLER: Return success
                deactivate POS_DAO
            end
            deactivate POS_DAO
            
        end

        group Validate Payer
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
        end
        group Validate Payee
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
        end
        PREP_HANDLER <-> PREP_HANDLER: Validate crypto-condition\n<color #FF0000><b>Error codes:</b> 3100</color>
        
        alt Validate Prepare Transfer (success)
            group Persist Transfer State (with transferState='RECEIVED-PREPARE')
                PREP_HANDLER -> POS_DAO: Request to persist transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    ilpPacket
                end note
                activate DB
                deactivate DB
                POS_DAO - -> PREP_HANDLER: Return success
                deactivate POS_DAO
            end
        else Validate Prepare Transfer (failure)
            group Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)
                PREP_HANDLER -> POS_DAO: Request to persist transfer\n(when Payee/Payer/crypto-condition validation fails)\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate POS_DAO
                POS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    transferError
                    ilpPacket
                end note
                activate DB
                deactivate DB
                POS_DAO - -> PREP_HANDLER: Return success
                deactivate POS_DAO
            end
        end

    end
    alt Validate Prepare Transfer (success)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_TRANSFER_POSITION
        deactivate TOPIC_TRANSFER_POSITION
    else Validate Prepare Transfer (failure)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.14.4
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>