<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1735px" preserveAspectRatio="none" style="width:888px;height:1735px;" version="1.1" viewBox="0 0 888 1735" width="888px" zoomAndPan="magnify"><defs><filter height="300%" id="f1p398axgw1b4i" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="329.5" y="23.5352">6.3.4. Settlement Transfer Abort</text><rect fill="#90EE90" height="1689.6465" style="stroke: #A80036; stroke-width: 1.0;" width="130" x="45" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="48" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1689.6465" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="541" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="544" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="1522.3594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="384.1426" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="673.293"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="850.7773"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1073.8828"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1273.6777"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1426.8516"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="1508.3594" style="stroke: #000000; stroke-width: 2.0;" width="863" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="1024.2852" style="stroke: #000000; stroke-width: 2.0;" width="842" x="23" y="610.3613"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="992.9746" style="stroke: #000000; stroke-width: 2.0;" width="822" x="33" y="634.6719"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="808.4902" style="stroke: #000000; stroke-width: 2.0;" width="802" x="43" y="812.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="110" x2="110" y1="116.2871" y2="1658.6465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="598" x2="598" y1="116.2871" y2="1658.6465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="113.334">Settlement DAO</text><ellipse cx="110" cy="83.7988" fill="#FEFECE" filter="url(#f1p398axgw1b4i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="98" x2="122" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="1671.1816">Settlement DAO</text><ellipse cx="110" cy="1690.1348" fill="#FEFECE" filter="url(#f1p398axgw1b4i)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="98" x2="122" y1="1704.1348" y2="1704.1348"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="550" y="113.334">Central Store</text><path d="M580,63.7988 C580,53.7988 598,53.7988 598,53.7988 C598,53.7988 616,53.7988 616,63.7988 L616,89.7988 C616,99.7988 598,99.7988 598,99.7988 C598,99.7988 580,99.7988 580,89.7988 L580,63.7988 " fill="#FEFECE" filter="url(#f1p398axgw1b4i)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M580,63.7988 C580,73.7988 598,73.7988 598,73.7988 C598,73.7988 616,73.7988 616,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="550" y="1671.1816">Central Store</text><path d="M580,1684.1348 C580,1674.1348 598,1674.1348 598,1674.1348 C598,1674.1348 616,1674.1348 616,1684.1348 L616,1710.1348 C616,1720.1348 598,1720.1348 598,1720.1348 C598,1720.1348 580,1720.1348 580,1710.1348 L580,1684.1348 " fill="#FEFECE" filter="url(#f1p398axgw1b4i)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M580,1684.1348 C580,1694.1348 598,1694.1348 598,1694.1348 C598,1694.1348 616,1694.1348 616,1684.1348 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="1522.3594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="384.1426" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="211.2188"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="673.293"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="850.7773"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1073.8828"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1273.6777"/><rect fill="#FFFFFF" filter="url(#f1p398axgw1b4i)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="593" y="1426.8516"/><path d="M13,133.2871 L234,133.2871 L234,140.2871 L224,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1508.3594" style="stroke: #000000; stroke-width: 2.0;" width="863" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="176" x="28" y="146.8555">Settlement Transfer Abort</text><path d="M120,155.5977 L120,180.5977 L705,180.5977 L705,165.5977 L695,155.5977 L120,155.5977 " fill="#D3D3D3" filter="url(#f1p398axgw1b4i)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M695,155.5977 L695,165.5977 L705,165.5977 L695,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="126" y="173.166">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="521" x="169" y="173.166">: settlementId that holds entries with ABORTED, transactionTimestamp, enums, trx</text><polygon fill="#A80036" points="581,207.2188,591,211.2188,581,215.2188,585,211.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="211.2188" y2="211.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="206.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="135" y="206.4766">Retrieve list of ABORTED, but not ABORTED yet</text><polygon fill="#FFFFE0" filter="url(#f1p398axgw1b4i)" points="340,224.2188,856,224.2188,866,396.2188,856,568.2188,340,568.2188,330,396.2188,340,224.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="342" y="240.7871">SELECT tp1.transferId, tp1.ledgerEntryTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="464" x="358" y="256.0977">tp1.participantCurrencyId AS dfspAccountId, tp1.amount AS dfspAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="456" x="358" y="271.4082">tp2.participantCurrencyId AS hubAccountId, tp2.amount AS hubAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="358" y="286.7188">tsc1.transferId isReserved</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="342" y="302.0293">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="382" y="302.0293">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="593" y="302.0293">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="342" y="317.3398">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="374" y="317.3398">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="670" y="317.3398">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="342" y="332.6504">ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="342" y="347.9609">AND spcsc.settlementStateId = {ABORTED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="342" y="363.2715">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="407" y="363.2715">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="550" y="363.2715">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="342" y="378.582">ON tsc1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="342" y="393.8926">AND tsc1.transferStateId = {RESERVED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="342" y="409.2031">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="407" y="409.2031">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="550" y="409.2031">tsc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="342" y="424.5137">ON tsc2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="342" y="439.8242">AND tsc2.transferStateId = {ABORTED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="342" y="455.1348">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="374" y="455.1348">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="505" y="455.1348">tp1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="342" y="470.4453">ON tp1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="342" y="485.7559">AND tp1.transferParticipantRoleTypeId = {DFSP_POSITION}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="342" y="501.0664">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="374" y="501.0664">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="505" y="501.0664">tp2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="342" y="516.377">ON tp2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="342" y="531.6875">AND tp2.transferParticipantRoleTypeId = {HUB}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="342" y="546.998">WHERE spc.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="342" y="562.3086">AND tsc2.transferId IS NULL</text><polygon fill="#A80036" points="126,591.3613,116,595.3613,126,599.3613,122,595.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="597" y1="595.3613" y2="595.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="590.6191">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="590.6191">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="190" y="590.6191">settlementTransferList</text><path d="M23,610.3613 L188,610.3613 L188,617.3613 L178,627.3613 L23,627.3613 L23,610.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1024.2852" style="stroke: #000000; stroke-width: 2.0;" width="842" x="23" y="610.3613"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="38" y="623.9297">DB TRANSACTION</text><path d="M33,634.6719 L107,634.6719 L107,641.6719 L97,651.6719 L33,651.6719 L33,634.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="992.9746" style="stroke: #000000; stroke-width: 2.0;" width="822" x="33" y="634.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="48" y="648.2402">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="122" y="647.3066">[t IN settlementTransferList]</text><polygon fill="#A80036" points="581,669.293,591,673.293,581,677.293,585,673.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="673.293" y2="673.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="668.5508">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="135" y="668.5508">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1p398axgw1b4i)" points="373,686.293,823,686.293,833,728.293,823,770.293,373,770.293,363,728.293,373,686.293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="375" y="702.8613">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="459" y="702.8613">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="602" y="702.8613">(transferId, transferStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="375" y="718.1719">VALUES (t.transferId, {REJECTED}, 'Settlement transfer reject')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="379" y="733.4824"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="375" y="748.793">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="459" y="748.793">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="602" y="748.793">(transferId, transferStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="375" x="375" y="764.1035">VALUES (t.transferId, {ABORTED}, 'Settlement transfer abort')</text><polygon fill="#A80036" points="126,793.1563,116,797.1563,126,801.1563,122,797.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="597" y1="797.1563" y2="797.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="792.4141">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="792.4141">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="190" y="792.4141">transferStateChangeId</text><path d="M43,812.1563 L110,812.1563 L110,819.1563 L100,829.1563 L43,829.1563 L43,812.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="808.4902" style="stroke: #000000; stroke-width: 2.0;" width="802" x="43" y="812.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="58" y="825.7246">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="490" x="125" y="824.791">[t.isReserved != undefined &amp;&amp; t.ledgerEntryTypeId == {SETTLEMENT_NET_RECIPIENT}]</text><polygon fill="#A80036" points="581,846.7773,591,850.7773,581,854.7773,585,850.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="850.7773" y2="850.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="846.0352">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="135" y="846.0352">Select dfsp position FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#f1p398axgw1b4i)" points="445,863.7773,751,863.7773,761,912.7773,751,962.7773,445,962.7773,435,912.7773,445,863.7773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="447" y="880.3457">SELECT participantPositionId AS dfspPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="463" y="895.6563">value AS dfspPositionValue,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="463" y="910.9668">reservedValue AS dfspReservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="447" y="926.2773">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="487" y="926.2773">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="447" y="941.5879">WHERE participantCurrencyId = t.dfspAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="447" y="956.8984">FOR UPDATE</text><polygon fill="#A80036" points="126,985.9512,116,989.9512,126,993.9512,122,989.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="597" y1="989.9512" y2="989.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="985.209">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="985.209">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="190" y="985.209">dfspPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="286" y="985.209">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="294" y="985.209">dfspPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="419" y="985.209">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="446" y="985.209">dfspReservedValue</text><path d="M120,1002.9512 L120,1042.9512 L708,1042.9512 L708,1012.9512 L698,1002.9512 L120,1002.9512 " fill="#D3D3D3" filter="url(#f1p398axgw1b4i)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M698,1002.9512 L698,1012.9512 L708,1012.9512 L698,1002.9512 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="561" x="126" y="1020.5195">To confirm if NDC reversal is required after review of Settlement reservation and commit.</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="126" y="1035.8301">(It is possible that NDC should be completed in commit flow, and not in reservation flow.)</text><polygon fill="#A80036" points="581,1069.8828,591,1073.8828,581,1077.8828,585,1073.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="1073.8828" y2="1073.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="1069.1406">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="135" y="1069.1406">Persist latest dfsp position &amp; dfsp position change</text><polygon fill="#FFFFE0" filter="url(#f1p398axgw1b4i)" points="371,1116.8828,825,1116.8828,835,1181.8828,825,1246.8828,371,1246.8828,361,1181.8828,371,1116.8828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="373" y="1133.4512">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="427" y="1133.4512">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="373" y="1148.7617">SET value = {dfspPositionValue - t.dfspAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="373" y="1164.0723">WHERE participantPositionId = {dfspPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="377" y="1179.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="373" y="1194.6934">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="457" y="1194.6934">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="401" y="1210.0039">(participantPositionId, transferStateChangeId, value, reservedValue)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="373" y="1225.3145">VALUES ({dfspPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="389" y="1240.625">{dfspPositionValue - t.dfspAmount}, {dfspReservedValue})</text><polygon fill="#A80036" points="581,1269.6777,591,1273.6777,581,1277.6777,585,1273.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="1273.6777" y2="1273.6777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="1268.9355">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="135" y="1268.9355">Select hub position FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#f1p398axgw1b4i)" points="447,1286.6777,749,1286.6777,759,1328.6777,749,1370.6777,447,1370.6777,437,1328.6777,447,1286.6777" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="449" y="1303.2461">SELECT participantPositionId AS hubPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="465" y="1318.5566">value AS hubPositionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="449" y="1333.8672">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="489" y="1333.8672">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="449" y="1349.1777">WHERE participantCurrencyId = t.hubAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="449" y="1364.4883">FOR UPDATE</text><polygon fill="#A80036" points="126,1393.541,116,1397.541,126,1401.541,122,1397.541" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="597" y1="1397.541" y2="1397.541"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="1392.7988">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="1392.7988">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="190" y="1392.7988">hubPositionId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="287" y="1392.7988">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="314" y="1392.7988">hubPositionValue</text><polygon fill="#A80036" points="581,1422.8516,591,1426.8516,581,1430.8516,585,1426.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="587" y1="1426.8516" y2="1426.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="122" y="1422.1094">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="144" y="1422.1094">Persist latest hub position &amp; hub position change</text><polygon fill="#FFFFE0" filter="url(#f1p398axgw1b4i)" points="441,1469.8516,754,1469.8516,764,1541.8516,754,1614.8516,441,1614.8516,431,1541.8516,441,1469.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="443" y="1486.4199">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="497" y="1486.4199">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="443" y="1501.7305">SET value = {hubPositionValue - t.hubAmount}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="443" y="1517.041">WHERE participantPositionId = {hubPositionId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="447" y="1532.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="443" y="1547.6621">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="527" y="1547.6621">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="459" y="1562.9727">(participantPositionId, transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="459" y="1578.2832">value, reservedValue)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="443" y="1593.5938">VALUES ({hubPositionId}, {transferStateChangeId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="459" y="1608.9043">{hubPositionValue - t.hubAmount}, 0)</text><!--
@startuml
title 6.3.4. Settlement Transfer Abort
autonumber

entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Settlement Service" #lightgreen
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

activate SETTLE_DAO
group Settlement Transfer Abort
    note right of SETTLE_DAO #lightgray
        **Inputs**: settlementId that holds entries with ABORTED, transactionTimestamp, enums, trx
    end note
    SETTLE_DAO -> DB: Retrieve list of ABORTED, but not ABORTED yet
    activate DB
    hnote over DB #lightyellow
        SELECT tp1.transferId, tp1.ledgerEntryTypeId,
            tp1.participantCurrencyId AS dfspAccountId, tp1.amount AS dfspAmount,
            tp2.participantCurrencyId AS hubAccountId, tp2.amount AS hubAmount,
            tsc1.transferId isReserved
        FROM **settlementParticipantCurrency** spc
        JOIN **settlementParticipantCurrencyStateChange** spcsc
        ON spcsc.settlementParticipantCurrencyId = spc.settlementParticipantCurrencyId
        AND spcsc.settlementStateId = {ABORTED}
        LEFT JOIN **transferStateChange** tsc1
        ON tsc1.transferId = spc.settlementTransferId
        AND tsc1.transferStateId = {RESERVED}
        LEFT JOIN **transferStateChange** tsc2
        ON tsc2.transferId = spc.settlementTransferId
        AND tsc2.transferStateId = {ABORTED}
        JOIN **transferParticipant** tp1
        ON tp1.transferId = spc.settlementTransferId
        AND tp1.transferParticipantRoleTypeId = {DFSP_POSITION}
        JOIN **transferParticipant** tp2
        ON tp2.transferId = spc.settlementTransferId
        AND tp2.transferParticipantRoleTypeId = {HUB}
        WHERE spc.settlementId = {settlementId}
        AND tsc2.transferId IS NULL
    end hnote
    DB - -> SETTLE_DAO: Return **settlementTransferList**
    deactivate DB
    group <color #blue>DB TRANSACTION</color>
        loop t IN settlementTransferList
            SETTLE_DAO -> DB: Persist transfer state
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason)
                VALUES (t.transferId, {REJECTED}, 'Settlement transfer reject')

                INSERT INTO **transferStateChange** (transferId, transferStateId, reason)
                VALUES (t.transferId, {ABORTED}, 'Settlement transfer abort')
            end note
            DB - -> SETTLE_DAO: Return **transferStateChangeId**
            deactivate DB

            opt t.isReserved != undefined && t.ledgerEntryTypeId == {SETTLEMENT_NET_RECIPIENT}
                SETTLE_DAO -> DB: Select dfsp position FOR UPDATE
                activate DB
                hnote over DB #lightyellow
                    SELECT participantPositionId AS dfspPositionId,
                        value AS dfspPositionValue,
                        reservedValue AS dfspReservedValue
                    FROM **participantPosition**
                    WHERE participantCurrencyId = t.dfspAccountId
                    FOR UPDATE
                end note
                DB - -> SETTLE_DAO: Return **dfspPositionId**, **dfspPositionValue** and **dfspReservedValue**
                deactivate DB

                note right of SETTLE_DAO #lightgray
                    <color #red>To confirm if NDC reversal is required after review of Settlement reservation and commit.</color>
                    <color #red>(It is possible that NDC should be completed in commit flow, and not in reservation flow.)</color>
                end note

                SETTLE_DAO->DB: Persist latest dfsp position & dfsp position change
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = {dfspPositionValue - t.dfspAmount}
                    WHERE participantPositionId = {dfspPositionId}

                    INSERT INTO **participantPositionChange**
                           (participantPositionId, transferStateChangeId, value, reservedValue)
                    VALUES ({dfspPositionId}, {transferStateChangeId},
                        {dfspPositionValue - t.dfspAmount}, {dfspReservedValue})
                end note
                activate DB
                deactivate DB

                SETTLE_DAO -> DB: Select hub position FOR UPDATE
                activate DB
                hnote over DB #lightyellow
                    SELECT participantPositionId AS hubPositionId,
                        value AS hubPositionValue
                    FROM **participantPosition**
                    WHERE participantCurrencyId = t.hubAccountId
                    FOR UPDATE
                end note
                DB - -> SETTLE_DAO: Return **hubPositionId** and **hubPositionValue**
                deactivate DB

                SETTLE_DAO->DB: Persist latest hub position & hub position change
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = {hubPositionValue - t.hubAmount}
                    WHERE participantPositionId = {hubPositionId}

                    INSERT INTO **participantPositionChange**
                        (participantPositionId, transferStateChangeId,
                        value, reservedValue)
                    VALUES ({hubPositionId}, {transferStateChangeId},
                        {hubPositionValue - t.hubAmount}, 0)
                end note
                activate DB
                deactivate DB
            end
        end
    end
end
deactivate SETTLE_DAO

@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>