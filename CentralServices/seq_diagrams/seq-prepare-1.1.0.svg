<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2044px" preserveAspectRatio="none" style="width:2378px;height:2044px;" version="1.1" viewBox="0 0 2378 2044" width="2378px" zoomAndPan="magnify"><defs><filter height="300%" id="fsqxc423ibjh6" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="400" x="990.25" y="23.5352">1.1.0. DFSP1 sends a Prepare Transfer request to DFSP2</text><rect fill="#D3D3D3" height="1999.3496" style="stroke: #A80036; stroke-width: 1.0;" width="186" x="4" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="7" y="47.0566">Financial Service Providers</text><rect fill="#ADD8E6" height="1999.3496" style="stroke: #A80036; stroke-width: 1.0;" width="562.5" x="286.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="489.25" y="47.0566">ML API Adapter Service</text><rect fill="#FFFFE0" height="1999.3496" style="stroke: #A80036; stroke-width: 1.0;" width="1510.5" x="851" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="1555.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="548.6953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="340.5" y="753.6445"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="1757.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="723.5" y="163.7754"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="71.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1078" y="1201.4082"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="1757.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1436" y="163.7754"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="1757.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1785" y="163.7754"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="1757.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2114" y="163.7754"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="1743.0859" style="stroke: #000000; stroke-width: 2.0;" width="2334.5" x="33" y="170.7754"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="67" x2="67" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="126" x2="126" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="345.5" x2="345.5" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="728" x2="728" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="922" x2="922" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1083" x2="1083" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1441" x2="1441" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1615" x2="1615" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1790" x2="1790" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1950" x2="1950" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2118.5" x2="2118.5" y1="153.7754" y2="1930.8613"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="2283.5" x2="2283.5" y1="153.7754" y2="1930.8613"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="43" y="134.334">DFSP1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="46" y="150.8223">Payer</text><ellipse cx="67.5" cy="63.7988" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M67.5,71.7988 L67.5,98.7988 M54.5,79.7988 L80.5,79.7988 M67.5,98.7988 L54.5,113.7988 M67.5,98.7988 L80.5,113.7988 " fill="#FEFECE" filter="url(#fsqxc423ibjh6)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="43" y="1943.3965">DFSP1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="46" y="1959.8848">Payer</text><ellipse cx="67.5" cy="1972.8379" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M67.5,1980.8379 L67.5,2007.8379 M54.5,1988.8379 L80.5,1988.8379 M67.5,2007.8379 L54.5,2022.8379 M67.5,2007.8379 L80.5,2022.8379 " fill="#FEFECE" filter="url(#fsqxc423ibjh6)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="102" y="134.334">DFSP2</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="39" x="104" y="150.8223">Payee</text><ellipse cx="126.5" cy="63.7988" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M126.5,71.7988 L126.5,98.7988 M113.5,79.7988 L139.5,79.7988 M126.5,98.7988 L113.5,113.7988 M126.5,98.7988 L139.5,113.7988 " fill="#FEFECE" filter="url(#fsqxc423ibjh6)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="102" y="1943.3965">DFSP2</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="39" x="104" y="1959.8848">Payee</text><ellipse cx="126.5" cy="1972.8379" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M126.5,1980.8379 L126.5,2007.8379 M113.5,1988.8379 L139.5,1988.8379 M126.5,2007.8379 L113.5,2022.8379 M126.5,2007.8379 L139.5,2022.8379 " fill="#FEFECE" filter="url(#fsqxc423ibjh6)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="290.5" y="150.8223">ML API Adapter</text><path d="M325,109.2871 L325,133.2871 M325,121.2871 L342,121.2871 " fill="#FEFECE" filter="url(#fsqxc423ibjh6)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354" cy="121.2871" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="290.5" y="1943.3965">ML API Adapter</text><path d="M325,1950.3496 L325,1974.3496 M325,1962.3496 L342,1962.3496 " fill="#FEFECE" filter="url(#fsqxc423ibjh6)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354" cy="1962.3496" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="227" x="612" y="150.8223">ML API Notification Event Handler</text><ellipse cx="728.5" cy="121.2871" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="724.5,109.2871,730.5,104.2871,728.5,109.2871,730.5,114.2871,724.5,109.2871" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="227" x="612" y="1943.3965">ML API Notification Event Handler</text><ellipse cx="728.5" cy="1962.3496" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="724.5,1950.3496,730.5,1945.3496,728.5,1950.3496,730.5,1955.3496,724.5,1950.3496" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128" x="855" y="150.8223">Central Service API</text><path d="M901.5,109.2871 L901.5,133.2871 M901.5,121.2871 L918.5,121.2871 " fill="#FEFECE" filter="url(#fsqxc423ibjh6)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="930.5" cy="121.2871" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128" x="855" y="1943.3965">Central Service API</text><path d="M901.5,1950.3496 L901.5,1974.3496 M901.5,1962.3496 L918.5,1962.3496 " fill="#FEFECE" filter="url(#fsqxc423ibjh6)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="930.5" cy="1962.3496" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1003" y="114.2871"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="999" y="118.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="1006" y="138.8223">Prepare-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="1003" y="1929.8613"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="999" y="1933.8613"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="1006" y="1954.3965">Prepare-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="1362" y="150.8223">Prepare Event Handler</text><ellipse cx="1441" cy="121.2871" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1437,109.2871,1443,104.2871,1441,109.2871,1443,114.2871,1437,109.2871" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="1362" y="1943.3965">Prepare Event Handler</text><ellipse cx="1441" cy="1962.3496" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1437,1950.3496,1443,1945.3496,1441,1950.3496,1443,1955.3496,1437,1950.3496" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="1534" y="114.2871"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="1530" y="118.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="1537" y="138.8223">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="1534" y="1929.8613"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="1530" y="1933.8613"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="1537" y="1954.3965">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="1710" y="150.8223">Position Event Handler</text><ellipse cx="1790" cy="121.2871" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1786,109.2871,1792,104.2871,1790,109.2871,1792,114.2871,1786,109.2871" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="1710" y="1943.3965">Position Event Handler</text><ellipse cx="1790" cy="1962.3496" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="1786,1950.3496,1792,1945.3496,1790,1950.3496,1792,1955.3496,1786,1950.3496" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1891" y="114.2871"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1887" y="118.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1894" y="138.8223">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1891" y="1929.8613"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1887" y="1933.8613"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="1894" y="1954.3965">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="2037.5" y="150.8223">Transfer Event Handler</text><ellipse cx="2119" cy="121.2871" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2115,109.2871,2121,104.2871,2119,109.2871,2121,114.2871,2115,109.2871" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="157" x="2037.5" y="1943.3965">Transfer Event Handler</text><ellipse cx="2119" cy="1962.3496" fill="#FEFECE" filter="url(#fsqxc423ibjh6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="2115,1950.3496,2121,1945.3496,2119,1950.3496,2121,1955.3496,2115,1950.3496" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="2214.5" y="114.2871"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="2210.5" y="118.2871"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="2217.5" y="138.8223">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="2214.5" y="1929.8613"/><rect fill="#FEFECE" filter="url(#fsqxc423ibjh6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="2210.5" y="1933.8613"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="2217.5" y="1954.3965">Notification-Topic</text><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="548.6953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="340.5" y="753.6445"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="1757.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="723.5" y="163.7754"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="71.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1078" y="1201.4082"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="1757.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1436" y="163.7754"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="1757.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1785" y="163.7754"/><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="1757.0859" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="2114" y="163.7754"/><rect fill="none" height="1743.0859" style="stroke: #000000; stroke-width: 2.0;" width="2334.5" x="33" y="170.7754"/><polygon fill="#EEEEEE" points="33,170.7754,412,170.7754,412,177.7754,402,187.7754,33,187.7754,33,170.7754" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="334" x="48" y="184.3438">DFSP1 sends a Prepare Transfer request to DFSP2</text><polygon fill="#FFFF00" filter="url(#fsqxc423ibjh6)" points="72,193.0859,72,723.0859,413,723.0859,413,203.0859,403,193.0859,72,193.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="403" x2="403" y1="193.0859" y2="203.0859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="413" x2="403" y1="203.0859" y2="203.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="78" y="210.6543">Headers - transferHeaders: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="94" y="225.9648">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="94" y="241.2754">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="94" y="256.5859">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="94" y="271.8965">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="94" y="287.207">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="94" y="302.5176">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="94" y="317.8281">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="94" y="333.1387">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="94" y="348.4492">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="94" y="363.7598">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="379.0703">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="82" y="394.3809"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="78" y="409.6914">Payload - transferMessage:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="425.002">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="94" y="440.3125">"transferId": &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="94" y="455.623">"payeeFsp": dfsp2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="94" y="470.9336">"payerFsp": dfsp1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="94" y="486.2441">"amount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="110" y="501.5547">"currency": "AED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="110" y="516.8652">"amount": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="94" y="532.1758">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="94" y="547.4863">"ilpPacket": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="94" y="562.7969">"condition": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="94" y="578.1074">"expiration": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="94" y="593.418">"extensionList": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="110" y="608.7285">"extension": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="126" y="624.0391">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="142" y="639.3496">"key": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="142" y="654.6602">"value": "string"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="126" y="669.9707">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="685.2813">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="700.5918">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="715.9023">}</text><polygon fill="#A80036" points="328.5,749.6445,338.5,753.6445,328.5,757.6445,332.5,753.6445" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="67.5" x2="334.5" y1="753.6445" y2="753.6445"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="74.5" y="749.2129">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="87.5" y="749.2129">POST - http://transfers</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="350.5" x2="392.5" y1="783.2656" y2="783.2656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="392.5" x2="392.5" y1="783.2656" y2="796.2656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351.5" x2="392.5" y1="796.2656" y2="796.2656"/><polygon fill="#A80036" points="361.5,792.2656,351.5,796.2656,361.5,800.2656,357.5,796.2656" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="357.5" y="778.5234">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="370.5" y="778.5234">Validate incoming token and originator matching Payer</text><polygon fill="#FFFF00" filter="url(#fsqxc423ibjh6)" points="355,809.2656,355,1171.2656,617,1171.2656,617,819.2656,607,809.2656,355,809.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="607" x2="607" y1="809.2656" y2="819.2656"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617" x2="607" y1="819.2656" y2="819.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="361" y="826.834">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="361" y="842.1445">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="377" y="857.4551">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="377" y="872.7656">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="377" y="888.0762">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="377" y="903.3867">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="377" y="918.6973">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="393" y="934.0078">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="393" y="949.3184">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="377" y="964.6289">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="377" y="979.9395">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="393" y="995.25">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="409" y="1010.5605">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="409" y="1025.8711">type: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="409" y="1041.1816">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="409" y="1056.4922">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="409" y="1071.8027">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="425" y="1087.1133">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="425" y="1102.4238">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="409" y="1117.7344">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="393" y="1133.0449">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="377" y="1148.3555">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="361" y="1163.666">}</text><polygon fill="#A80036" points="1066,1197.4082,1076,1201.4082,1066,1205.4082,1070,1201.4082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="350.5" x2="1072" y1="1201.4082" y2="1201.4082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="357.5" y="1196.9766">3</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="271" x="370.5" y="1196.9766">Route &amp; Publish Prepare event for Payer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1088" x2="1130" y1="1231.0293" y2="1231.0293"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1130" x2="1130" y1="1231.0293" y2="1244.0293"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1089" x2="1130" y1="1244.0293" y2="1244.0293"/><polygon fill="#A80036" points="1099,1240.0293,1089,1244.0293,1099,1248.0293,1095,1244.0293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1095" y="1226.2871">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1108" y="1226.2871">Ensure event is replicated as configured (ACKS=all)</text><polygon fill="#A80036" points="361.5,1269.0293,351.5,1273.0293,361.5,1277.0293,357.5,1273.0293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="355.5" x2="1082" y1="1273.0293" y2="1273.0293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="367.5" y="1268.5977">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="380.5" y="1268.5977">Respond replication acknoledgements have been received</text><polygon fill="#A80036" points="78.5,1298.3398,68.5,1302.3398,78.5,1306.3398,74.5,1302.3398" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="72.5" x2="344.5" y1="1302.3398" y2="1302.3398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="84.5" y="1297.9082">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="97.5" y="1297.9082">Respond HTTP - 202 (Accepted)</text><polygon fill="#A80036" points="1094,1352.6504,1084,1356.6504,1094,1360.6504,1090,1356.6504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1088" x2="1435" y1="1356.6504" y2="1356.6504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1100" y="1352.2188">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1113" y="1352.2188">Consume message</text><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="703" x="996" y="1364.9609"/><polygon fill="#EEEEEE" points="996,1364.9609,1060,1364.9609,1060,1371.9609,1050,1381.9609,996,1381.9609,996,1364.9609" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="1009" y="1379.5293">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="269" x="1213" y="1398.5293">Prepare Handler Consume {1.1.1.a, 1.1.1.b}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1217" y="1413.8398"/><polygon fill="#A80036" points="1603,1442.8926,1613,1446.8926,1603,1450.8926,1607,1446.8926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1446" x2="1609" y1="1446.8926" y2="1446.8926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1453" y="1442.4609">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="1466" y="1442.4609">Produce message</text><polygon fill="#A80036" points="1626,1497.2031,1616,1501.2031,1626,1505.2031,1622,1501.2031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1620" x2="1784" y1="1501.2031" y2="1501.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1632" y="1496.7715">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1645" y="1496.7715">Consume message</text><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="485" x="1527" y="1509.5137"/><polygon fill="#EEEEEE" points="1527,1509.5137,1591,1509.5137,1591,1516.5137,1581,1526.5137,1527,1526.5137,1527,1509.5137" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="1540" y="1524.082">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="1632.5" y="1543.082">Position Handler Consume {1.1.2.a, 1.1.2.b}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1636.5" y="1558.3926"/><polygon fill="#A80036" points="1938,1587.4453,1948,1591.4453,1938,1595.4453,1942,1591.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1795" x2="1944" y1="1591.4453" y2="1591.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1802" y="1587.0137">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="1824" y="1587.0137">Produce message</text><polygon fill="#A80036" points="1961,1641.7559,1951,1645.7559,1961,1649.7559,1957,1645.7559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1955" x2="2113" y1="1645.7559" y2="1645.7559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1967" y="1641.3242">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="1989" y="1641.3242">Consume message</text><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="472.5" x="1884" y="1654.0664"/><polygon fill="#EEEEEE" points="1884,1654.0664,1948,1654.0664,1948,1661.0664,1938,1671.0664,1884,1671.0664,1884,1654.0664" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="1897" y="1668.6348">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="1982.75" y="1687.6348">Transfer Handler Consume {1.1.3.a, 1.2.3.b}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1986.75" y="1702.9453"/><polygon fill="#A80036" points="2272,1731.998,2282,1735.998,2272,1739.998,2276,1735.998" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="2124" x2="2278" y1="1735.998" y2="1735.998"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="2131" y="1731.5664">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="2153" y="1731.5664">Produce message</text><polygon fill="#A80036" points="2272,1786.3086,2282,1790.3086,2272,1794.3086,2276,1790.3086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="733.5" x2="2278" y1="1790.3086" y2="1790.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="740.5" y="1785.877">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="762.5" y="1785.877">Consume message</text><rect fill="#FFFFFF" filter="url(#fsqxc423ibjh6)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="2257.5" x="99" y="1798.6191"/><polygon fill="#EEEEEE" points="99,1798.6191,163,1798.6191,163,1805.6191,153,1815.6191,99,1815.6191,99,1798.6191" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="112" y="1813.1875">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="1053.25" y="1832.1875">Send notification to Participant (Payee) {1.1.4.a, 1.1.4.b}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1057.25" y="1847.498"/><polygon fill="#A80036" points="137.5,1876.5508,127.5,1880.5508,137.5,1884.5508,133.5,1880.5508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="131.5" x2="722.5" y1="1880.5508" y2="1880.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="143.5" y="1876.1191">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="165.5" y="1876.1191">Send callback notification</text><!--
@startuml
' declate title
title 1.1.0. DFSP1 sends a Prepare Transfer request to DFSP2

autonumber

' Actor Keys:
'   boundary - APIs/Interfaces, etc
'   collections - Kafka Topics
'   control - Kafka Consumers
'   entity - Database Access Objects
'   database - Database Persistance Store

' declare actors
actor "DFSP1\nPayer" as DFSP1
actor "DFSP2\nPayee" as DFSP2
boundary "ML API Adapter" as MLAPI
control "ML API Notification Event Handler" as NOTIFY_HANDLER
boundary "Central Service API" as CSAPI
collections "Prepare-Topic-dfsp1" as TOPIC_PREPARE_DFSP1
control "Prepare Event Handler" as PREP_HANDLER
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
control "Transfer Event Handler" as TRANS_HANDLER
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
' collections "Errors-Topic" as ERRORS_NOTIFICATIONS
' entity "Position DAO" as POS_DAO
' entity "Event DAO" as EVENT_DAO
' entity "Transfer DAO" as TRANS_DAO
' entity "Notification DAO" as NOTIFY_DAO
' entity "Participant DAO" as PARTICIPANT_DAO
' database "Central Store" as DB

box "Financial Service Providers" #lightGray
	participant DFSP1
	participant DFSP2
end box

box "ML API Adapter Service" #LightBlue
	participant MLAPI
	participant NOTIFY_HANDLER
end box

box "Central Service" #LightYellow
    participant CSAPI
	participant TOPIC_PREPARE_DFSP1
    participant PREP_HANDLER
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TRANS_HANDLER
    participant TOPIC_NOTIFICATIONS
    ' participant ERRORS_NOTIFICATIONS
    ' participant POS_DAO
    ' participant EVENT_DAO
    ' participant TRANS_DAO
    ' participant NOTIFY_DAO
    ' participant PARTICIPANT_DAO
    ' participant DB
end box

' start flow
activate NOTIFY_HANDLER
activate PREP_HANDLER
activate POS_HANDLER
activate TRANS_HANDLER
group DFSP1 sends a Prepare Transfer request to DFSP2
    note right of DFSP1 #yellow
        Headers - transferHeaders: {
            Content-Length: <Content-Length>,
            Content-Type: <Content-Type>,
            Date: <Date>,
            X-Forwarded-For: <X-Forwarded-For>,
            FSPIOP-Source: <FSPIOP-Source>,
            FSPIOP-Destination: <FSPIOP-Destination>,
            FSPIOP-Encryption: <FSPIOP-Encryption>,
            FSPIOP-Signature: <FSPIOP-Signature>,
            FSPIOP-URI: <FSPIOP-URI>,
            FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
        }

        Payload - transferMessage:
        {
            "transferId": <uuid>,
            "payeeFsp": dfsp2,
            "payerFsp": dfsp1,
            "amount": {
                "currency": "AED",
                "amount": "string"
            },
            "ilpPacket": "string",
            "condition": "string",
            "expiration": "string",
            "extensionList": {
                "extension": [
                    {
                        "key": "string",
                        "value": "string"
                    }
                ]
            }
        }
    end note
    DFSP1 -> MLAPI: POST - http://transfers
    activate MLAPI
    MLAPI -> MLAPI: Validate incoming token and originator matching Payer
    note right of MLAPI #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    type: prepare,
                    action: prepare,
                    createdAt: <timestamp>,
                    state: {
                        status: "success",
                        code: 0
                    }
                }
            }
        }
    end note
    MLAPI -> TOPIC_PREPARE_DFSP1: <color #FF0000>**Route & Publish Prepare event for Payer**</color>
    activate TOPIC_PREPARE_DFSP1
    TOPIC_PREPARE_DFSP1 <-> TOPIC_PREPARE_DFSP1: Ensure event is replicated as configured (ACKS=all)
    TOPIC_PREPARE_DFSP1 - -> MLAPI: Respond replication acknoledgements have been received
    deactivate TOPIC_PREPARE_DFSP1
    MLAPI - - -> DFSP1: Respond HTTP - 202 (Accepted)
    deactivate MLAPI
    |||
    TOPIC_PREPARE_DFSP1 <- PREP_HANDLER: Consume message
    ref over TOPIC_PREPARE_DFSP1, PREP_HANDLER, TOPIC_POSITION_DFSP1 :  Prepare Handler Consume {1.1.1.a, 1.1.1.b} \n
    PREP_HANDLER -> TOPIC_POSITION_DFSP1: Produce message
    |||
    TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume message
    ref over TOPIC_POSITION_DFSP1, POS_HANDLER, TOPIC_TRANSFERS : Position Handler Consume {1.1.2.a, 1.1.2.b} \n
    POS_HANDLER -> TOPIC_TRANSFERS: Produce message
    |||
    TOPIC_TRANSFERS <- TRANS_HANDLER: Consume message
    ref over TOPIC_TRANSFERS, TRANS_HANDLER, TOPIC_NOTIFICATIONS : Transfer Handler Consume {1.1.3.a, 1.2.3.b} \n
    TRANS_HANDLER -> TOPIC_NOTIFICATIONS: Produce message
    |||
    TOPIC_NOTIFICATIONS <- NOTIFY_HANDLER: Consume message
    ref over DFSP2, TOPIC_NOTIFICATIONS : Send notification to Participant (Payee) {1.1.4.a, 1.1.4.b} \n
    NOTIFY_HANDLER -> DFSP2: Send callback notification
    |||
end
deactivate TRANS_HANDLER
deactivate POS_HANDLER
deactivate PREP_HANDLER
deactivate NOTIFY_HANDLER
@enduml

PlantUML version 1.2017.18(Fri Oct 06 17:56:32 BST 2017)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_152-b16
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>